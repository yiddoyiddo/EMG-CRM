generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String @id @default(cuid())
  name           String?
  email          String @unique
  hashedPassword String
  role           Role   @default(BDR)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model Lead {
  id            Int            @id @default(autoincrement())
  name          String
  title         String?
  addedDate     DateTime       @default(now())
  bdr           String?
  company       String?
  source        String
  status        String
  link          String?
  phone         String?
  notes         String?
  email         String?        @unique
  activityLogs  ActivityLog[]
  pipelineItems PipelineItem[]

  @@index([status])
  @@index([source])
  @@index([addedDate])
  @@index([bdr, addedDate])
  @@index([bdr])
  @@index([bdr, status])
}

model PipelineItem {
  id                  Int            @id @default(autoincrement())
  name                String
  title               String?
  addedDate           DateTime       @default(now())
  lastUpdated         DateTime       @default(now())
  bdr                 String
  company             String?
  category            String
  status              String
  value               Float?
  probability         Int?
  expectedCloseDate   DateTime?
  link                String?
  phone               String?
  notes               String?
  email               String?
  leadId              Int?
  callDate            DateTime?
  parentId            Int?
  isSublist           Boolean        @default(false)
  sublistName         String?
  sortOrder           Int?
  agreementDate       DateTime?
  partnerListDueDate  DateTime?
  partnerListSentDate DateTime?
  firstSaleDate       DateTime?
  partnerListSize     Int?
  totalSalesFromList  Int?
  activityLogs        ActivityLog[]
  lead                Lead?          @relation(fields: [leadId], references: [id])
  parent              PipelineItem?  @relation("PipelineSublist", fields: [parentId], references: [id])
  children            PipelineItem[] @relation("PipelineSublist")

  @@index([callDate])
  @@index([agreementDate])
  @@index([partnerListSentDate])
  @@index([firstSaleDate])
  @@index([category])
  @@index([status])
  @@index([lastUpdated])
  @@index([addedDate])
  @@index([parentId])
  @@index([leadId])
  @@index([status, lastUpdated])
  @@index([category, status])
  @@index([parentId, sortOrder])
  @@index([isSublist, parentId])
  @@index([bdr, agreementDate])
  @@index([bdr, callDate])
  @@index([bdr, category])
  @@index([bdr, firstSaleDate])
  @@index([bdr])
  @@index([bdr, lastUpdated])
  @@index([bdr, partnerListSentDate])
  @@index([bdr, status])
}

model ActivityLog {
  id               Int           @id @default(autoincrement())
  timestamp        DateTime      @default(now())
  bdr              String
  activityType     String
  description      String
  scheduledDate    DateTime?
  completedDate    DateTime?
  notes            String?
  leadId           Int?
  pipelineItemId   Int?
  previousStatus   String?
  newStatus        String?
  previousCategory String?
  newCategory      String?
  lead             Lead?         @relation(fields: [leadId], references: [id])
  pipelineItem     PipelineItem? @relation(fields: [pipelineItemId], references: [id])

  @@index([activityType, timestamp])
  @@index([timestamp])
  @@index([activityType])
  @@index([pipelineItemId])
  @@index([leadId])
  @@index([pipelineItemId, timestamp])
  @@index([activityType, bdr])
  @@index([bdr, activityType])
  @@index([bdr])
  @@index([bdr, timestamp])
  @@index([timestamp, bdr])
}

model KpiTarget {
  id    Int    @id @default(autoincrement())
  name  String @unique
  value Int
}

model FinanceEntry {
  id                Int       @id @default(autoincrement())
  company           String
  bdr               String
  leadGen           Boolean   @default(false)
  status            String
  invoiceDate       DateTime?
  dueDate           DateTime?
  soldAmount        Float?
  gbpAmount         Float?
  exchangeRate      Float?
  exchangeRateDate  DateTime?
  actualGbpReceived Float?
  notes             String?
  commissionPaid    Boolean   @default(false)
  month             String    @default("2025-01")
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([status])
  @@index([invoiceDate])
  @@index([dueDate])
  @@index([month])
  @@index([createdAt])
  @@index([status, month])
  @@index([month, createdAt])
  @@index([status, createdAt])
  @@index([bdr, createdAt])
  @@index([bdr])
  @@index([bdr, month])
  @@index([bdr, status])
  @@index([bdr, status, month])
}

enum Role {
  ADMIN
  BDR
}
